\begin{algorithm}[!t]
\SetAlgoLined
\KwIn{%
AABBs of primitives: $\mathcal{B}$,\quad
ID sub-range: $I^\prime$,\quad
node index: $n$,\quad
offset of $I$ in the original array: $o$,\quad
configuration: $c$
}
\KwOut{%
Updated node array $N$,\quad
partitioned ID array $I$
}

Compute bounding box $A_n = \bigcup_{i \in I^\prime} \mathcal{B}[i]$\;

\If{$|I| \leq c.\mathrm{leaf\_size}$}{
  Mark $N[n]$ as a leaf with children $(o, |I^\prime|) \subseteq I$\;
  \Return
}

Set split axis $a \gets \arg\max \mathrm{diag}(A_n)$\;
Set $N[n].\mathrm{axis} \gets a$\;

Initialize $work\_ids \gets I^\prime$,\quad
$p \gets \mathrm{balanced\_split}(c.\mathrm{inner\_size})$,\quad
$child \gets \mathrm{first\_child\_index}(n)$\;

\While{$!work\_ids.\mathrm{empty}()$}{
  \If{$|work\_ids| \geq p$}{
    Apply \texttt{F::partition} (with $n = p$) to $work\_ids$ along axis $a$\;
  }
  $next\_ids \gets \mathrm{take}(work\_ids, p)$\;
  
  Dispatch on node $N[child]$ with $next\_ids$, offset $o + (|I| - |work\_ids|)$\;
  
  $work\_ids \gets \mathrm{drop}(work\_ids, |next\_ids|)$\;
  $child \gets child + 1$\;
}

Mark $N[n]$ as an inner node with children\\
$(\mathrm{first\_child\_index}(n), c.\mathrm{inner\_size}) \subseteq N$\;

	\caption{In-place tree construction with $\mathrm{nth\_element}$-based partitioning of ID range.}
	\label{alg:build-tree}
\end{algorithm}
